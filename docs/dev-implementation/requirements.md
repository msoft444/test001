# 要件定義書：テーマ切替（ダーク/寒色/暖色）

## 1. 目的/スコープ
### 1.1 目的
現状「ダークモードのみ」提供されている前提の見た目切替機能を拡張し、ユーザーが **寒色系（Cool）** / **暖色系（Warm）** を含む複数テーマへ切り替えできるようにする。

### 1.2 スコープ
- 対象：ダッシュボード（marunage-dashboard）での表示（会話一覧、会話詳細、タスク/ログ、成果物表示、フォーム、通知）
- 対象：テーマ設定の保持・伝搬（必要に応じてバックエンド/DBに保存）
- 非対象：エージェントの推論品質、タスク実行ロジックそのものの変更

### 1.3 用語
- テーマ(theme)：UIの色・背景・アクセント等のトークンセット。
- ダーク(dark)：暗い背景ベースのテーマ。
- 寒色(cool)：青/シアン寄りの色温度（アクセントや背景のトーンを冷たく）。
- 暖色(warm)：橙/赤寄りの色温度（アクセントや背景のトーンを暖かく）。

## 2. 機能要件
### FR-1 テーマ種別
- 以下のテーマを選択できること：
  - `dark`
  - `cool`
  - `warm`
- 既存のデフォルトがある場合は維持しつつ、上記を追加すること。
- 補足（推奨）：将来拡張のため `system`（OS設定追従）を内部的に扱える設計にする（UI上に出すかは任意）。

### FR-2 切替UI
- 設定画面またはヘッダー等、ユーザーが常時アクセス可能な導線からテーマを切り替えできること。
- 変更は即時反映（ページリロード不要）を基本とする。

### FR-3 永続化
- 最低限：ブラウザローカル（例：localStorage）に保存し、再訪時に同一テーマが復元されること。
- 追加要件（任意/要確認）：ログインユーザー単位にサーバ側へ保存し、端末間同期できること。

### FR-4 互換性
- テーマ未設定/不正値の場合は安全にデフォルトへフォールバックすること。
- 既存のメッセージ/成果物表示を崩さないこと（Markdown、コードブロック、テーブル等）。

### FR-5 アクセシビリティ
- 主要テキストと背景のコントラストが十分であること（少なくともWCAG AA相当を目標、厳密測定は別途）。
- 状態表現（成功/警告/失敗）が色だけに依存しないこと（アイコン、ラベル等で補完）。

### FR-6 運用/観測性
- テーマ変更イベントを（必要なら）ログ/分析基盤へ送れること（個人情報を含めない）。

## 3. 非機能要件
- パフォーマンス：テーマ切替により目視できるレイテンシ（体感遅延）がないこと（目安：100ms程度で反映）。
- 安定性：不正なテーマ値受領時もUI/バックエンドが例外で落ちない。
- セキュリティ：テーマ設定値はホワイトリスト検証し、任意CSS/JS注入の経路を作らない。
- 互換性：既存DBフィールド（conversations.constraints_json）運用に影響を与えない。

## 4. 制約・前提
- 本リポジトリはエージェント基盤（Python）であり、UI（marunage-dashboard）のソースが含まれていない。
- DBはMariaDB、会話情報は `conversations` テーブルの `constraints_json` を利用している（通常フロー：配列、devフロー：辞書）。
- ダッシュボードとの連携はメッセージバス（messages）および WS 更新（conversation.updated を示唆）に依存する。

## 5. 主要テストシナリオ
（別セクションの test_scenarios に列挙）
