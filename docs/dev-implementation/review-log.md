# 戦略レビューログ

## 総合判定: NeedsFix（軽微 — 実装着手可能だが下記論点の解決を推奨）

## 重大論点（優先度付き）

### P1（高）: constraints_json 二重運用のリスク
- **問題**: constraints_json は通常フローで list[str]、devフローで dict として使われる。ui_preferences をここに格納する案は型安全性を損なう可能性がある。
- **現状コード確認**: schemas.py L29 では `constraints_json: list[str]` と型定義されているが、manager_agent.py の dev フローでは dict として扱われる箇所が示唆されている。
- **推奨**: UIテーマはUI側の関心事であるため、constraints_json への格納は避け、localStorage のみの最小構成で初期実装する。サーバ永続化が必要になった場合は専用テーブル or 専用カラムを検討する。
- **テスト影響**: constraints_json に不正なテーマ値が混入した場合の回帰テストが必要。

### P1（高）: テーマIDのホワイトリスト検証の実装箇所
- **問題**: フロントエンドとバックエンド両方でバリデーションが必要だが、検証ロジックの重複管理が必要。
- **推奨**: フロントエンド（TypeScript定数）とバックエンド（Python定数）の両方に ALLOWED_THEMES = {'dark', 'cool', 'warm'} を定義。system は内部値として許容するが UI には露出しない。
- **テスト影響**: 両側でのバリデーションテストが必要。

### P2（中）: デフォルトテーマの決定
- **問題**: 要件定義に「既存のデフォルトがある場合は維持」とあるが、具体的なデフォルト値が未定義。
- **推奨**: デフォルトを `dark` とし、localStorage 未設定時・不正値時のフォールバック先として明示する。
- **テスト影響**: デフォルトフォールバックのテストケースに直結。

### P2（中）: system テーマの扱い
- **問題**: 内部値として許容するが UI に出すかは任意。prefers-color-scheme メディアクエリとの連携仕様が未定義。
- **推奨**: v1 では system テーマは実装せず、将来対応として内部的にバリデーションのみ通す。
- **テスト影響**: system 値がバリデーションを通ること、ただしUI上では選択不可であることのテスト。

### P3（低）: パフォーマンス計測方法
- **問題**: 「100ms以内」という非機能要件があるが、計測方法が未定義。
- **推奨**: Performance API (performance.now()) でテーマ切替前後の時間差を計測。CI での自動計測は将来課題。

### P3（低）: テーマ変更イベントのログ仕様
- **問題**: FR-6 で「必要なら」ログ送信とあるが、イベントスキーマが未定義。
- **推奨**: { event: 'theme_changed', theme_id: string, previous_theme_id: string, timestamp: string } を最小スキーマとする。個人情報は含めない。

## 未解決事項
1. marunage-dashboard のフロントエンド技術スタック（React/Vue/Svelte等）が未確認 — テスト実装の具体的なフレームワーク選定に影響
2. ダッシュボードのビルド/デプロイパイプラインが未確認 — CIでのビジュアルリグレッションテスト導入可否に影響
3. サーバ永続化の優先度が未確定（v1 では localStorage のみで合意できるか）
4. 既存ダークモードの実装状況が未確認（CSS変数ベースか、ハードコードか）